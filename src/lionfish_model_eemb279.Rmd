---
title: "lionfish_model_eemb279"
author: "Leonardo Feitosa"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(patchwork)
```

# Introduction

(Background and context, approximately 200 words, citing at least two additional research papers.)

## Motivation

Invasive species management requires thorough understanding of life history characteristics, which can be used to model population dynamics and analyze effectiveness of various intervention strategies. Lionfish are invasive and have spread rapidly through the western Atlantic, but spatially-explicit estimates for growth rate have not been identified in many regions. This paper uses length-frequency data to estimate lionfish growth rate in one of these areas: northeast Florida. 

## Paper's Key Goals & Findings:

1. Develop length-based model to estimate age, growth, and population structure - found rapid growth with seasonal variation

2. Evaluate model performance through validation with otolith analysis and external length-frequency data

3. Estimate vital rates and population structure for the region - distinct cohorts were identifiable, suggesting recruitment occurs during a relatively short summer period; majority of lionfish < 2 years of age, none > 3 years of age

## Methods

#### Sampling

Sampling occured from 2013-2015 during "lionfish roundup" tournaments and other opportunistic sampling via spearfishing. In the lab, lionfish were measured for standard and total length, weighed, and sexed. The authors retrieved otoliths from 100 lionfish to determine age directly. 

#### Model Creation

- Length-frequency histograms were used for lengths 0-450mm in 10mm increments.
- Only used data from 2014 due to temporal resolution

About the model:

The von Bertalanffy growth function uses length as a proxy for age. For species which experience seasonal temperature variations, such as temperate lionfish, the seasonalized version of this function is often most appropriate:

$$
\begin{align}
\text{Seasonalized:} 
\newline 
L_t & = L_{inf} [1-e^{-(K(t-t_0))-S(t)+S(t_0)}] \\ 
\newline
S(t)  &= \frac{CK}{2\pi} \cdot sin \pi(t-t_s)
\newline
S(t_0) &= \frac{CK}{2\pi} \cdot sin \pi(t_0-t_s)
\end{align}
$$

$L_t$ = length of fish at age $t$
$L_inf$ = asymptotic maximum length
$K$ = Brody growth coefficient
$t_0$ = theoretical time at which fish was length zero
$t_s$ = seasonal growth oscillations relative to $t_0$
$t_w = t_s + 0.5$ = winter point, time of slowest growth
$C$ = intensity of seasonal growth oscillation, ($0 \leq C \leq 1$ where zero = no seasonality)

Included measure of variance of size-at-age as a parameter, and estimated the proportion of lionfish in each age class during each sampling month and year:

$$
\begin{align}
n_{a,i,t} = N_t \cdot P_{a,t} \cdot P(L_{lower} \leq L_i \leq L_{upper} | N(\bar{L_{a,t}},\sigma_{a}^{2}))
\end{align}
$$
$N_t$ = total number of individuals captured in month $t$
$P_{a,t}$ = probability of fish captured in month $t$ being age $a$
$L_{lower}$ and $L_{upper}$ = lower and upper bounds of predcted 10mm size bin
$N(\bar{L_{a,t}}, sigma_a)$ = normal probability density function with mean length $\bar{L_{a,t}}$ of fish of age $a$ in month $t$ as estimated from seasonalized VBGF and model esimated standard deviation at age, $sigma_a$. 

Size distributions overlap across ages, so total expected fish of size $i$ in month $t$ calculated by summing expected contributions to size class $i$ from each age:
$N_{i,t} = \sum_{a=0}^{3}n_{i,a,t}$

Uses maximum likelihood approach to fit a predicted distribution to the length-frequency histogram - length is a proxy for age, so the model estimates the proportion of fish of a given size in each age class. 

Best fit model:
$$
\begin{align}
L_t = 448 [1-e^{-0.47t+[\frac{0.061*0.47}{2\pi}]sin\pi(t-0.71)]-[\frac{0.61*0.47}{2\pi}sin\pi(0.71)]}]
\end{align}
$$
## Replication

### Data Processing

```{r}
lionfish_tl <- read.csv(here("data", "lionfish_length-frequency_data.csv"), sep = ";") %>% 
  clean_names() %>% 
  select(total_length_tl:august_2015)

# Create tibble in long format and separate the original year column into month and year
lionfish_long <- lionfish_tl %>% 
  pivot_longer(cols = april_2013:august_2015,
               names_to = "year",
               values_to = "frequency") %>% 
  separate(year, c("month", "year"), "_")

# Sum the frequencies per year
lionfish_sum <- lionfish_long %>% 
  group_by(year, total_length_tl) %>% 
  summarise(freq_sum = sum(frequency))

```

### Length-Frequency Histograms:


```{r}
lion_ap_2013 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = april_2013)) +
  labs(x = "",
       y = "",
       title = "April 2013") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_aug_2013 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2013)) +
  labs(x = "",
       y = "",
       title = "August 2013") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_ap_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = april_2014)) +
  labs(x = "",
       y = "",
       title = "April 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_jul_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = july_2014)) +
  labs(x = "",
       y = "",
       title = "July 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_aug_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2014)) +
  labs(x = "",
       y = "",
       title = "August 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_oc_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = october_2014)) +
  labs(x = "",
       y = "",
       title = "October 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_nov_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = november_2014)) +
  labs(x = "",
       y = "",
       title = "November 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_jan_2015 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = january_2015)) +
  labs(x = "",
       y = "",
       title = "January 2015") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_aug_2015 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2015)) +
  labs(x = "",
       y = "",
       title = "August 2015") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, fig.height=10}
(lion_ap_2013 + lion_aug_2013) /
  (lion_ap_2014 + lion_jul_2014) /
  (lion_aug_2014 + lion_oc_2014) /
  (lion_nov_2014 + lion_jan_2015) /
  (lion_aug_2015) +
  plot_annotation(tag_levels = "A")
```

##### Cleaner Alternative: ggplot + facet_wrap()

```{r}
ggplot(data = lionfish_long) +
  geom_col(aes(x = total_length_tl, y = frequency)) +
  theme_classic() +
  labs(x = "Total Length",
       y = "Frequency") +
  facet_wrap(~year, scales = "free")
```

```{r parameters}
l_inf = 448 # asymptotic maximum length
k = 0.47    # Brody growth coefficient
c = 0.61    # intensity of seasonal growth oscillation. 
               # varies from 0 to 1, with zero being no seasonality 
               # and one extreme seasonality
t_0 = 0    # theoretical time when fish was length zero
t_s = 0.71 # timing of seasonal growth oscillation...
              # slowest growth is at winter point, tw = ts + 0.5

# Values of temperature for each location
# MaranhÃ£o
t_m = 25  # Moura et al (2016)

# Fernando de Noronha
t_fn = 24 # Prazeres et al (2012)

# Rio de Janeiro
t_rj = 23 # Lima & Coutinho (2016)

# Northeast Florida
t_fl = 22.5 # based on monthly averages for Jacksonville obtained from https://seatemperature.info/jacksonville-water-temperature.html 

```

## Replicating the best fit model used in Johnson & Swenarton (2016)

### Figure 4

```{r}
# Parameters 
l_inf = 448 # asymptotic maximum length
k = 0.47    # Brody growth coefficient
c = 0.61    # intensity of seasonal growth oscillation. 
               # varies from 0 to 1, with zero being no seasonality 
               # and one extreme seasonality
t_0 = 0    # theoretical time when fish was length zero
t_s = 0.71 # timing of seasonal growth oscillation...
              # slowest growth is at winter point, tw = ts + 0.5

# Set up loop to iterate model across time/age
tset <- seq(from = 0, to = 4, by = 0.001)
lf <- data.frame(tset, lengths = NaN*tset)

for(i in 1:length(tset)){
  t <- tset[i]
  l_t <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  lf$lengths[i] <- l_t
}

# Plot the model output
ggplot() +
  geom_line(data = lf,
            aes(x = tset, y = lengths)) +
  labs(x = "Age (Years)",
       y = "Total Length (mm)") +
  theme_classic()
```

##  Figure 3

Now need to try to use the growth to estimate the age structure of the population:


```{r}
# Starting age structure,
lf_ap13 <- lionfish_long %>% 
  filter(month == "april" & year == "2013") %>% 
  uncount(frequency) %>% 
  select(total_length_tl) %>% 
  rename(starting_length = total_length_tl) 

# Create table of age-length relationships
# (Nice alternative to solving the model for length)
lf_nice <- lf %>%  
  mutate(length_round = round(lengths, digits = 0))%>% 
  group_by(length_round) %>% 
  slice(1) %>% 
  ungroup()

lf_sim <- data.frame(start_l = lf_ap13$starting_length,
                     start_a    = NaN*length(lf_ap13),
                     a_1 = NaN*length(lf_ap13),
                     l_1 = NaN*length(lf_ap13),
                     a_2 = NaN*length(lf_ap13),
                     l_2 = NaN*length(lf_ap13), 
                     a_3 = NaN*length(lf_ap13),
                     l_3 = NaN*length(lf_ap13),
                     a_4 = NaN*length(lf_ap13),
                     l_4 = NaN*length(lf_ap13))

# Test out first as a loop
for(i in 1:length(lf_sim$start_l)){
    # Starting Age/Length
    a <- lf_nice$tset[lf_nice$length_round == lf_sim$start_l[i]] 
    lf_sim$start_a[i] <- a
    
    # 1-yr Age/Length
    t <- a + 1
    lf_sim$a_1[i] <- t
    lf_sim$l_1[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim$a_2[i] <- t
    lf_sim$l_2[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim$a_3[i] <- t
    lf_sim$l_3[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim$a_4[i] <- t
    lf_sim$l_4[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
}


  
# Works!
ggplot(data = lf_sim) +
  geom_histogram(aes(x = start_l, fill = "April 2013"), alpha = 0.5)+
  geom_histogram(aes(x = l_1, fill = "April 2013 aged to April 2014"), alpha = 0.5) +
  geom_histogram(aes(x = l_2, fill = "April 2013 aged to April 2015"), alpha = 0.5) +
  geom_histogram(aes(x = l_3, fill = "April 2013 aged to April 2016"), alpha = 0.5) +
  geom_histogram(aes(x = l_4, fill = "April 2013 aged to April 2017"), alpha = 0.5) +
  labs(x = "length", y = "frequency", fill = NULL) +
  theme_classic()
```


## Model extension 

### Figure 3

```{r}
# Starting age structure,
lf_ap13 <- lionfish_long %>% 
  filter(month == "april" & year == "2013") %>% 
  uncount(frequency) %>% 
  select(total_length_tl) %>% 
  rename(starting_length = total_length_tl) 

# Create table of age-length relationships
# (Nice alternative to solving the model for length)
lf_nice <- lf %>%  
  mutate(length_round = round(lengths, digits = 0))%>% 
  group_by(length_round) %>% 
  slice(1) %>% 
  ungroup()
```

```{r for loop for florida}
lf_sim_fl <- data.frame(start_l_fl = lf_ap13$starting_length,
                     start_a_fl  = NaN*length(lf_ap13),
                     a_1_fl = NaN*length(lf_ap13),
                     l_1_fl = NaN*length(lf_ap13),
                     a_2_fl = NaN*length(lf_ap13),
                     l_2_fl = NaN*length(lf_ap13), 
                     a_3_fl = NaN*length(lf_ap13),
                     l_3_fl = NaN*length(lf_ap13),
                     a_4_fl = NaN*length(lf_ap13),
                     l_4_fl = NaN*length(lf_ap13))

# Test out first as a loop
for(i in 1:length(lf_sim_fl$start_l_fl)){
    # Starting Age/Length
    a_fl <- lf_nice$tset[lf_nice$length_round == lf_sim_fl$start_l_fl[i]] 
    lf_sim_fl$start_a[i] <- a_fl
    
    # 1-yr Age/Length
    t_flo <- a_fl + 1
    lf_sim_fl$a_1_fl[i] <- t_flo
    lf_sim_fl$l_1_fl[i] <- l_inf*t_fl*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t_flo <- t_flo + 1
    lf_sim_fl$a_2_fl[i] <- t_flo
    lf_sim_fl$l_2_fl[i] <- l_inf*t_fl*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t_flo <- t_flo + 1
    lf_sim_fl$a_3_fl[i] <- t_flo
    lf_sim_fl$l_3_fl[i] <- l_inf*t_fl*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t_flo <- t_flo + 1
    lf_sim_fl$a_4_fl[i] <- t_flo
    lf_sim_fl$l_4_fl[i] <- l_inf* t_fl*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
}

```


```{r for loop for maranhao}
lf_sim_m <- data.frame(start_l_m = lf_ap13$starting_length,
                     start_a_m = NaN*length(lf_ap13),
                     a_1_m = NaN*length(lf_ap13),
                     l_1_m = NaN*length(lf_ap13),
                     a_2_m = NaN*length(lf_ap13),
                     l_2_m = NaN*length(lf_ap13), 
                     a_3_m = NaN*length(lf_ap13),
                     l_3_m = NaN*length(lf_ap13),
                     a_4_m = NaN*length(lf_ap13),
                     l_4_m = NaN*length(lf_ap13),
                     region = NaN*length(lf_ap13))

for(i in 1:length(lf_sim_m$start_l_m)){
    # Starting Age/Length
    a_m <- lf_nice$tset[lf_nice$length_round == lf_sim_m$start_l_m[i]] 
    lf_sim_m$start_a_m[i] <- a_m
    
    # 1-yr Age/Length
    t <- a_m + 1
    lf_sim_m$a_1_m[i] <- t
    lf_sim_m$l_1_m[i] <- l_inf* t_m *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim_m$a_2_m[i] <- t
    lf_sim_m$l_2_m[i] <- l_inf*t_m *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_m$a_3_m[i] <- t
    lf_sim_m$l_3_m[i] <- l_inf*t_m *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_m$a_4_m[i] <- t
    lf_sim_m$l_4_m[i] <- l_inf*t_m *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # add region to the df
    region <- t + 1
    lf_sim_m$region[i] <- c("MA")
}

```

```{r for loop for noronha}
lf_sim_fn <- data.frame(start_l_fn = lf_ap13$starting_length,
                     start_a_fn = NaN*length(lf_ap13),
                     a_1_fn = NaN*length(lf_ap13),
                     l_1_fn = NaN*length(lf_ap13),
                     a_2_fn = NaN*length(lf_ap13),
                     l_2_fn = NaN*length(lf_ap13), 
                     a_3_fn = NaN*length(lf_ap13),
                     l_3_fn = NaN*length(lf_ap13),
                     a_4_fn = NaN*length(lf_ap13),
                     l_4_fn = NaN*length(lf_ap13),
                     region = NaN*length(lf_ap13))

for(i in 1:length(lf_sim_fn$start_l_fn)){
    # Starting Age/Length
    a_fn <- lf_nice$tset[lf_nice$length_round == lf_sim_fn$start_l_fn[i]] 
    lf_sim_fn$start_a_fn[i] <- a_fn
    
    # 1-yr Age/Length
    t_f <- a_fn + 1
    lf_sim_fn$a_1_fn[i] <- t_f
    lf_sim_fn$l_1_fn[i] <- l_inf* t_fn *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t_f <- t_f + 1
    lf_sim_fn$a_2_fn[i] <- t_f
    lf_sim_fn$l_2_fn[i] <- l_inf*t_fn *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t_f <- t_f + 1
    lf_sim_fn$a_3_fn[i] <- t_f
    lf_sim_fn$l_3_fn[i] <- l_inf*t_fn *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t_f <- t_f + 1
    lf_sim_fn$a_4_fn[i] <- t_f
    lf_sim_fn$l_4_fn[i] <- l_inf*t_fn *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # include region in the df
    region <- t_f + 1
    lf_sim_fn$region[i] <- c("FN")
}
```

```{r for loop for rj}
lf_sim_rj <- data.frame(start_l_rj = lf_ap13$starting_length,
                     start_a_rj = NaN*length(lf_ap13),
                     a_1_rj = NaN*length(lf_ap13),
                     l_1_rj = NaN*length(lf_ap13),
                     a_2_rj = NaN*length(lf_ap13),
                     l_2_rj = NaN*length(lf_ap13), 
                     a_3_rj = NaN*length(lf_ap13),
                     l_3_rj = NaN*length(lf_ap13),
                     a_4_rj = NaN*length(lf_ap13),
                     l_4_rj = NaN*length(lf_ap13),
                     region = NaN*length(lf_ap13))

for(i in 1:length(lf_sim_rj$start_l_rj)){
    # Starting Age/Length
    a_rj <- lf_nice$tset[lf_nice$length_round == lf_sim_rj$start_l_rj[i]] 
    lf_sim_rj$start_a_rj[i] <- a_rj
    
    # 1-yr Age/Length
    t_r <- a_rj + 1
    lf_sim_rj$a_1_rj[i] <- t_r
    lf_sim_rj$l_1_rj[i] <- l_inf* t_rj *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t_r <- t_r + 1
    lf_sim_rj$a_2_rj[i] <- t_r
    lf_sim_rj$l_2_rj[i] <- l_inf*t_rj *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t_r <- t_r + 1
    lf_sim_rj$a_3_rj[i] <- t_r
    lf_sim_rj$l_3_rj[i] <- l_inf*t_rj *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t_r <- t_r + 1
    lf_sim_rj$a_4_rj[i] <- t_r
    lf_sim_rj$l_4_rj[i] <- l_inf*t_rj *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # include region in the df
    region <- t_r + 1
    lf_sim_rj$region[i] <- c("RJ")
}
```


```{r plot for figure 3 model extension}
ggplot(data = lf_sim_m) +
  geom_histogram(aes(x = start_l_m, fill = "April 2013"), alpha = 0.5)+
  geom_histogram(aes(x = l_1_m, fill = "April 2013 aged to April 2014"), alpha = 0.5) +
  geom_histogram(aes(x = l_2_m, fill = "April 2013 aged to April 2015"), alpha = 0.5) +
  geom_histogram(aes(x = l_3_m, fill = "April 2013 aged to April 2016"), alpha = 0.5) +
  geom_histogram(aes(x = l_4_m, fill = "April 2013 aged to April 2017"), alpha = 0.5) +
  labs(x = "Length", y = "Frequency", fill = NULL, title = "Simulation for Maranhao") +
  theme_classic()

ggplot(data = lf_sim_fn) +
  geom_histogram(aes(x = start_l_fn, fill = "April 2013"), alpha = 0.5)+
  geom_histogram(aes(x = l_1_fn, fill = "April 2013 aged to April 2014"), alpha = 0.5) +
  geom_histogram(aes(x = l_2_fn, fill = "April 2013 aged to April 2015"), alpha = 0.5) +
  geom_histogram(aes(x = l_3_fn, fill = "April 2013 aged to April 2016"), alpha = 0.5) +
  geom_histogram(aes(x = l_4_fn, fill = "April 2013 aged to April 2017"), alpha = 0.5) +
  labs(x = "Length", y = "Frequency", fill = NULL, title = "Simulation for Fernando de Noronha") +
  theme_classic()

ggplot(data = lf_sim_rj) +
  geom_histogram(aes(x = start_l_rj, fill = "April 2013"), alpha = 0.5)+
  geom_histogram(aes(x = l_1_rj, fill = "April 2013 aged to April 2014"), alpha = 0.5) +
  geom_histogram(aes(x = l_2_rj, fill = "April 2013 aged to April 2015"), alpha = 0.5) +
  geom_histogram(aes(x = l_3_rj, fill = "April 2013 aged to April 2016"), alpha = 0.5) +
  geom_histogram(aes(x = l_4_rj, fill = "April 2013 aged to April 2017"), alpha = 0.5) +
  labs(x = "Length", y = "Frequency", fill = NULL, title = "Simulation for Rio de Janeiro") +
  theme_classic()

ggplot(data = lf_sim_fl) +
  geom_histogram(aes(x = start_l_fl, fill = "April 2013"), alpha = 0.5)+
  geom_histogram(aes(x = l_1_fl, fill = "April 2013 aged to April 2014"), alpha = 0.5) +
  geom_histogram(aes(x = l_2_fl, fill = "April 2013 aged to April 2015"), alpha = 0.5) +
  geom_histogram(aes(x = l_3_fl, fill = "April 2013 aged to April 2016"), alpha = 0.5) +
  geom_histogram(aes(x = l_4_fl, fill = "April 2013 aged to April 2017"), alpha = 0.5) +
  labs(x = "length", y = "frequency", fill = NULL, title = "Florida Simulation") +
  theme_classic()
```


### Figure 4 - Model extension Leo

```{r}
# Set up loop to iterate model across time/age
tset <- seq(from = 0, to = 4, by = 0.001)
lf <- data.frame(tset, lengths = NaN*tset)
lf_m <- data.frame(tset, lengths = NaN*tset)
lf_fn <- data.frame(tset, lengths = NaN*tset)
lf_rj <- data.frame(tset, lengths = NaN*tset)
for(i in 1:length(tset)){
  t <- tset[i]
  
  l_t <- l_inf*t_fl *(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  l_t_m <- l_inf*t_m* (1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  l_t_fn <- l_inf*t_fn* (1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  l_t_rj <- l_inf*t_rj* (1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  
  lf$lengths[i] <- l_t
  lf_m$lengths[i] <- l_t_m
  lf_fn$lengths[i] <- l_t_fn
  lf_rj$lengths[i] <- l_t_rj
}

# Plot the model output
ggplot() +
  geom_line(data = lf,
            aes(x = tset, y = lengths)) +
  geom_line(data = lf_m,
            aes(x = tset, y = lengths),
            color = "coral2") +
  geom_line(data = lf_fn,
            aes(x = tset, y = lengths),
            color = "blue4") +
  geom_line(data = lf_rj,
            aes(x = tset, y = lengths),
            color = "goldenrod2") +
  labs(x = "Age (Years)",
       y = "Total Length (mm)") +
  theme_classic()
```


