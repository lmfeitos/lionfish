---
title: "Model Extension Report"
author: "Leonardo Feitosa"
date: "17 March 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(tidyverse)
#library(plyr)
library(here)
library(janitor)
library(patchwork)
library(kableExtra)
library(ggridges)
```

# Introduction

  Invasive species management requires thorough understanding of life history characteristics, which can be used to model population dynamics and analyze effectiveness of various intervention strategies. Lionfish (*Pterois volitans/miles*) are an invasive species in the Caribbean, and have caused substantial harm to both the regional biological community and the people who rely on coral reefs for economic subsistence (Albins, 2015; Albins & Hixon, 2013). Since individual growth rates are often dependent on local environmental conditions, spatially-explicit estimates are necessary to better understand and manage lionfish invasions. Growth curves for this species have been generated for many locations throughout the Caribbean Sea (Akins et al., 2014; Rodríguez-Cortés, 2015). The paper we analyze in this project, by Eric G. Johnson and Mary Katherine Swenarton (2016), fills the knowledge gap on the individual-level growth patterns in a temperate population in Northeastern Florida. 

  Growth studies are also critical to understand how predator-prey interactions might be influenced by a rapid-growth invasive species such as the lionfish (Lorenzen, 2006). Johnson and Swenarton (2016) study the growth patterns and evaluate the population structure of *Pterois volitans/miles* through length-frequency data, applying a modified version of the von Bertalanffy Growth Function (VBGF) to include seasonality as an environmental parameter. In this paper, we recreate some of the analyses they performed in their paper and discuss the ecological importance of their results.  

# Model Presentation

The von Bertalanffy growth function uses length as a proxy for age. Generally, the length of a fish increases as it gets older, and many fish species demonstrate rapid growth as juveniles that then decreases as they near their maximum size. For species which experience seasonal temperature variations, such as temperate lionfish, the seasonalized version of this length-age function is often most appropriate:

$$
\begin{align}
\text{Seasonalized:} 
\newline 
L_t & = L_\infty [1-e^{-(K(t-t_0))-S(t)+S(t_0)}] \\ 
\newline
S(t)  &= \frac{CK}{2\pi} \cdot sin \pi(t-t_s)
\newline
S(t_0) &= \frac{CK}{2\pi} \cdot sin \pi(t_0-t_s)
\end{align}
$$

Here, the length of a fish at a certain age ($L_t$) is a function of the Brody growth coefficient ($K$) and fluctuations in the growth rate depending on the seasonal growth patterns (described by $S(t)$ and $S(t_0)$). The intensity of these fluctuations is controlled by $C$, where $C = 0$ indicates no seasonality, and $C = 1$ indicates complete seasonality. A complete list of parameters and their descriptions are included in Table 1. 


## Model Extension's Key Goals & Findings:

The paper analyzed in this project (Johnson & Swenarton 2016) consists of the calculations of growth for the lionfish (Pterois volitans/miles) in Northeastern Florida. While growth curves for this species have been generated throughout the region independently (Akins et al., 2014; Rodríguez-Cortés, 2015), the paper we analyzed does it in a very local scale within a limited time frame (2013-2015). Therefore, my proposal for an extension of this model is to include sea water temperature as another parameter, given that water temperature is key to the development and reproductive parameters of fish (Rountrey et al., 2014). Furthermore, given the recent extension records of the invasive lionfish beyond the Caribbean and as far south as Rio de Janeiro, southeastern Brazil (Ferreira et al., 2015; Luiz et al., 2021), the populations of this species are likely to be subjected to different sea water temperatures, thus likely exhibiting different growth patterns.

***Table 1. Description of variables and parameters for the seasonalized von-Bertalanffy growth equation with the addition of mean water temperature (T)***
```{r echo=FALSE}
# Insert table here
table <- data.frame("Term" = c("$L_t$",
                               "$t$",
                               "$L_\\infty$",
                               "$K$",
                               "$t_0$",
                               "$t_s$",
                               "$t_w$",
                               "$t_b$",
                               "$C$",
                               "$T$"),
                    "Estimate" = c("output variable (mm)",
                                   "input variable (yr)",
                                   "448 mm",
                                   "0.47 yr$^{-1}$",
                                   "0 yr",
                                   "0.71 yr",
                                   "not stated",
                                   "0.41 yr",
                                   "0.61",
                                   "22.5(Fl), 23 (BRJ), 24 (BFN), 25 (BNB)"),
                    "Description" = c("length of fish at age $t$",
                                      "age $t$",
                                      "asymptotic maximum length",
                                      "Brody growth coefficient",
                                      "theoretical time at which fish was length zero artificial constant set at zero for this paper)",
                                      "seasonal growth oscillation relative to $t_0$",
                                      "winter point, time of slowest growth ($t_w = t_s + 0.5$)",
                                      "time of annual recruitment",
                                      "intensity of seasonal growth oscillation 
                                      ($0 \\leq C \\leq 1$, where zero indicates 
                                      no seasonality and one indicates complete seasonality)",
                                      "water temperature (ºC). FL - Florda, BRJ - Rio de Janeiro,
                                      BFN - Fernando de Noronha Archipelago, BNB - Northern Brazilian coast"))
kable(table) %>% 
  kable_styling()
```


The authors used a maximum likelihood approach to fit a predicted distribution to the length-frequency histograms from samples of collected lionfish. Length is a proxy for age, so the model estimates the proportion of fish of a given size in each age class. In the Johnson & Swenarton (2016) paper, this function was used to estimate the parameters for the best fit model shown below. 

$$
\begin{align}
L_t = 448 [1-e^{-0.47t+[\frac{0.061*0.47}{2\pi}]sin\pi(t-0.71)]-[\frac{0.61*0.47}{2\pi}sin\pi(0.71)]}]
\end{align}
$$

In this model extension, I add temperature ($T$) as a parameter to describe the effect of different water temperatures on the growth patterns of lionfish. Temperature values were retrived from the literature for places outside the Caribbean where this species has been recently recorded. These include the Amazon reefs (Luiz et al, 2021), the Fernando de Noronha Archipelago in Brazil (Luiz et al, 2021), and Rio de Janeiro state, Brazil (Ferreira et al, 2015). All values of $T$ were obtained through average temperatures published in the literature (Lima & Coutinho, 2008; Prazeres et al 2012; Moura et al 2016). Given that by including $T$ in the original model increases predicted $L_t$, I also decided to get an yearly average water temperature value for northeast Florida (https://seatemperature.info/jacksonville-water-temperature.html) to enable comparisons across areas. With this modification, the model is as follows:

$$
\begin{align}
L_t = 448*T [1-e^{-0.47t+[\frac{0.061*0.47}{2\pi}]sin\pi(t-0.71)]-[\frac{0.61*0.47}{2\pi}sin\pi(0.71)]}]
\end{align}
$$

This model assumes the following:

- All individuals are identical and experience the same environmental conditions
- Individual growth is only controlled by the passage of time and predicted seasonal oscillations (e.g. not affected by changes in conditions, predator presence, prey availability)
- The distribution of lengths in the population follows a normal distribution
- The population of lionfish has only four age classes
- Lionfish in this population reach an average maximum length of 448 mm
- The samples collected via spearfishing are reflective of the age-length distribution of the population
- Recruitment occurs in a single event on the same day each year


```{r, echo = FALSE}
lionfish_tl <- read.csv(here("data", "lionfish_length-frequency_data.csv"), sep = ";") %>% 
  clean_names() %>% 
  select(total_length_tl:august_2015)

# Create tibble in long format and separate the original year column into month and year
lionfish_long <- lionfish_tl %>% 
  pivot_longer(cols = april_2013:august_2015,
               names_to = "year",
               values_to = "frequency") %>% 
  separate(year, c("month", "year"), "_")
 
# Sum the frequencies per year
lionfish_sum <- lionfish_long %>% 
  group_by(year, total_length_tl) %>% 
  summarise(freq_sum = sum(frequency))
```



```{r}
ggplot(data = lionfish_long) +
  geom_col(aes(x = total_length_tl, y = frequency)) +
  theme_classic() +
  labs(x = "Total Length",
       y = "Frequency (# lionfish)") +
  facet_wrap(~year, scales = "free")
```

```{r parameters}
l_inf = 448 # asymptotic maximum length
# Values of temperature for each location
# Maranhão
t_m = 25  # Moura et al (2016)

# Fernando de Noronha
t_fn = 24 # Prazeres et al (2012)

# Rio de Janeiro
t_rj = 23 # Lima & Coutinho (2016)

# Northeast Florida
t_fl = 22.5 # based on monthly averages for Jacksonville obtained from https://seatemperature.info/jacksonville-water-temperature.html 

s = 1 # scaling constant
k = 0.47    # Brody growth coefficient
k_fl = k * exp(s*(t_fl - t_fl)) # florida
k_m = k * exp(s*(t_m - t_fl)) # amazon reefs
k_fn = k * exp(s*(t_fn - t_fl)) # fernando de noronha
k_rj = k * exp(s*(t_rj - t_fl)) # rio de janeiro
c = 0.61    # intensity of seasonal growth oscillation. 
               # varies from 0 to 1, with zero being no seasonality 
               # and one extreme seasonality
t_0 = 0    # theoretical time when fish was length zero
t_s = 0.71 # timing of seasonal growth oscillation...
              # slowest growth is at winter point, tw = ts + 0.5
```


## Model extension results

```{r, include = FALSE}
# Set up loop to iterate model across time/age
tset <- seq(from = 0, to = 4, by = 0.001)
lf <- data.frame(tset, lengths = NaN*tset)

for(i in 1:length(tset)){
  t <- tset[i]
  l_t <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  lf$lengths[i] <- l_t
}

ggplot(data = lf) +
  geom_line(aes(x = tset, y = lengths))

# Starting age structure,
lf_ap13 <- lionfish_long %>% 
  filter(month == "april" & year == "2013") %>% 
  uncount(frequency) %>% 
  dplyr::select(total_length_tl) %>% 
  dplyr::rename(starting_length = total_length_tl) 

# Create table of age-length relationships
# (Nice alternative to solving the model for length)
lf_nice <- lf %>%  
  mutate(length_round = round(lengths, digits = 0))%>% 
  group_by(length_round) %>% 
  slice(1) %>% 
  ungroup()
```


```{r for loop for florida}
lf_sim_fl <- data.frame(start_l_fl = lf_ap13$starting_length,
                     start_a_fl  = NaN*length(lf_ap13),
                     a_1_fl = NaN*length(lf_ap13),
                     l_1_fl = NaN*length(lf_ap13),
                     a_2_fl = NaN*length(lf_ap13),
                     l_2_fl = NaN*length(lf_ap13), 
                     a_3_fl = NaN*length(lf_ap13),
                     l_3_fl = NaN*length(lf_ap13),
                     a_4_fl = NaN*length(lf_ap13),
                     l_4_fl = NaN*length(lf_ap13))

# Test out first as a loop
for(i in 1:length(lf_sim_fl$start_l_fl)){
    # Starting Age/Length
    a_fl <- lf_nice$tset[lf_nice$length_round == lf_sim_fl$start_l_fl[i]] 
    lf_sim_fl$start_a_fl[i] <- a_fl
    
    # 1-yr Age/Length
    t <- a_fl + 1
    lf_sim_fl$a_1_fl[i] <- t
    lf_sim_fl$l_1_fl[i] <- l_inf*(1-exp(-k_fl*(t-t_0)+(((c*k_fl)/(2*pi))*sinpi(t-t_s))-(((c*k_fl)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim_fl$a_2_fl[i] <- t
    lf_sim_fl$l_2_fl[i] <- l_inf*(1-exp(-k_fl*(t-t_0)+(((c*k_fl)/(2*pi))*sinpi(t-t_s))-(((c*k_fl)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_fl$a_3_fl[i] <- t
    lf_sim_fl$l_3_fl[i] <- l_inf*(1-exp(-k_fl*(t-t_0)+(((c*k_fl)/(2*pi))*sinpi(t-t_s))-(((c*k_fl)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_fl$a_4_fl[i] <- t
    lf_sim_fl$l_4_fl[i] <- l_inf*(1-exp(-k_fl*(t-t_0)+(((c*k_fl)/(2*pi))*sinpi(t-t_s))-(((c*k_fl)/(2*pi))*sinpi(t_s))))
    
    # add region
    region <- t + 1
    lf_sim_fl$region[i] <- c("Northeast Florida")
}

lf_sim_fl_long <- lf_sim_fl %>% 
  select(start_l_fl, l_1_fl, l_2_fl, l_3_fl, l_4_fl, region) %>% 
  pivot_longer(cols = c("start_l_fl", "l_1_fl", "l_2_fl", "l_3_fl", "l_4_fl"),
               names_to = "time",
               values_to = "length") %>% 
  mutate(time = as.factor(case_when(time == "start_l_fl" ~ "Initial Population",
                                    time == "l_1_fl" ~ "After 1 Year",
                                    time == "l_2_fl" ~ "After 2 Years",                            
                                    time == "l_3_fl" ~ "After 3 Years",
                                    time == "l_4_fl" ~ "After 4 Years"))) %>% 
  mutate(time = fct_relevel(time, levels = c("Initial Population", "After 1 Year", 
                                           "After 2 Years",  "After 3 Years", "After 4 Years")))

# Works!
ggplot(data = lf_sim_fl_long) +
  geom_density_line(aes(x = length, color = time, fill = time), 
                    alpha = 0.5) +
  labs(color = NULL,
       fill = NULL,
       x = "length (mm)",
       y = "frequency (number of lionfish)",
       title = "Northeast Florida") +
  theme_classic()+
  facet_wrap(~time, ncol = 1) +
  theme(strip.text = element_blank(),
        aspect.ratio = 1/5)
```


```{r for loop for maranhao}
lf_sim_m <- data.frame(start_l_m = lf_ap13$starting_length,
                     start_a_m = NaN*length(lf_ap13),
                     a_1_m = NaN*length(lf_ap13),
                     l_1_m = NaN*length(lf_ap13),
                     a_2_m = NaN*length(lf_ap13),
                     l_2_m = NaN*length(lf_ap13), 
                     a_3_m = NaN*length(lf_ap13),
                     l_3_m = NaN*length(lf_ap13),
                     a_4_m = NaN*length(lf_ap13),
                     l_4_m = NaN*length(lf_ap13),
                     region = NaN*length(lf_ap13))

for(i in 1:length(lf_sim_m$start_l_m)){
    # Starting Age/Length
    a_m <- lf_nice$tset[lf_nice$length_round == lf_sim_m$start_l_m[i]] 
    lf_sim_m$start_a_m[i] <- a_m
    
    # 1-yr Age/Length
    t <- a_m + 1
    lf_sim_m$a_1_m[i] <- t
    lf_sim_m$l_1_m[i] <- l_inf*(1-exp(-k_m*(t-t_0)+(((c*k_m)/(2*pi))*sinpi(t-t_s))-(((c*k_m)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim_m$a_2_m[i] <- t
    lf_sim_m$l_2_m[i] <- l_inf*(1-exp(-k_m*(t-t_0)+(((c*k_m)/(2*pi))*sinpi(t-t_s))-(((c*k_m)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_m$a_3_m[i] <- t
    lf_sim_m$l_3_m[i] <- l_inf*(1-exp(-k_m*(t-t_0)+(((c*k_m)/(2*pi))*sinpi(t-t_s))-(((c*k_m)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_m$a_4_m[i] <- t
    lf_sim_m$l_4_m[i] <- l_inf*(1-exp(-k_m*(t-t_0)+(((c*k_m)/(2*pi))*sinpi(t-t_s))-(((c*k_m)/(2*pi))*sinpi(t_s))))
    
    # add region to the df
    region <- t + 1
    lf_sim_m$region[i] <- c("Amazon Reefs")
}

lf_sim_m_long <- lf_sim_m %>% 
  select(start_l_m, l_1_m, l_2_m, l_3_m, l_4_m, region) %>% 
  pivot_longer(cols = c("start_l_m", "l_1_m", "l_2_m", "l_3_m", "l_4_m"),
               names_to = "time",
               values_to = "length") %>% 
  mutate(time = as.factor(case_when(time == "start_l_m" ~ "Initial Population",
                                    time == "l_1_m" ~ "After 1 Year",
                                    time == "l_2_m" ~ "After 2 Years",                            
                                    time == "l_3_m" ~ "After 3 Years",
                                    time == "l_4_m" ~ "After 4 Years"))) %>% 
  mutate(time = fct_relevel(time, levels = c("Initial Population", "After 1 Year", 
                                           "After 2 Years",  "After 3 Years", "After 4 Years")))

# Works!
ggplot(data = lf_sim_m_long) +
  geom_density_line(aes(x = length, color = time, fill = time), 
                    alpha = 0.5) +
  labs(color = NULL,
       fill = NULL,
       x = "length (mm)",
       y = "frequency (number of lionfish)",
       title = "Amazon reefs") +
  theme_classic()+
  facet_wrap(~time, ncol = 1) +
  theme(strip.text = element_blank(),
        aspect.ratio = 1/5)
```

```{r for loop for noronha}
lf_sim_fn <- data.frame(start_l_fn = lf_ap13$starting_length,
                     start_a_fn = NaN*length(lf_ap13),
                     a_1_fn = NaN*length(lf_ap13),
                     l_1_fn = NaN*length(lf_ap13),
                     a_2_fn = NaN*length(lf_ap13),
                     l_2_fn = NaN*length(lf_ap13), 
                     a_3_fn = NaN*length(lf_ap13),
                     l_3_fn = NaN*length(lf_ap13),
                     a_4_fn = NaN*length(lf_ap13),
                     l_4_fn = NaN*length(lf_ap13),
                     region = NaN*length(lf_ap13))

for(i in 1:length(lf_sim_fn$start_l_fn)){
    # Starting Age/Length
    a_fn <- lf_nice$tset[lf_nice$length_round == lf_sim_fn$start_l_fn[i]] 
    lf_sim_fn$start_a_fn[i] <- a_fn
    
    # 1-yr Age/Length
    t <- a_fn + 1
    lf_sim_fn$a_1_fn[i] <- t
    lf_sim_fn$l_1_fn[i] <- l_inf*(1-exp(-k_fn*(t-t_0)+(((c*k_fn)/(2*pi))*sinpi(t-t_s))-(((c*k_fn)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim_fn$a_2_fn[i] <- t
    lf_sim_fn$l_2_fn[i] <- l_inf*(1-exp(-k_fn*(t-t_0)+(((c*k_fn)/(2*pi))*sinpi(t-t_s))-(((c*k_fn)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_fn$a_3_fn[i] <- t
    lf_sim_fn$l_3_fn[i] <- l_inf*(1-exp(-k_fn*(t-t_0)+(((c*k_fn)/(2*pi))*sinpi(t-t_s))-(((c*k_fn)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_fn$a_4_fn[i] <- t
    lf_sim_fn$l_4_fn[i] <- l_inf*(1-exp(-k_fn*(t-t_0)+(((c*k_fn)/(2*pi))*sinpi(t-t_s))-(((c*k_fn)/(2*pi))*sinpi(t_s))))
    
    # include region in the df
    region <- t + 1
    lf_sim_fn$region[i] <- c("Fernando de Noronha")
}

lf_sim_fn_long <- lf_sim_fn %>% 
  select(start_l_fn, l_1_fn, l_2_fn, l_3_fn, l_4_fn, region) %>% 
  pivot_longer(cols = c("start_l_fn", "l_1_fn", "l_2_fn", "l_3_fn", "l_4_fn"),
               names_to = "time",
               values_to = "length") %>% 
  mutate(time = as.factor(case_when(time == "start_l_fn" ~ "Initial Population",
                                    time == "l_1_fn" ~ "After 1 Year",
                                    time == "l_2_fn" ~ "After 2 Years",                            
                                    time == "l_3_fn" ~ "After 3 Years",
                                    time == "l_4_fn" ~ "After 4 Years"))) %>% 
  mutate(time = fct_relevel(time, levels = c("Initial Population", "After 1 Year", 
                                           "After 2 Years",  "After 3 Years", "After 4 Years")))

# Works!
ggplot(data = lf_sim_fn_long) +
  geom_density_line(aes(x = length, color = time, fill = time), 
                    alpha = 0.5) +
  labs(color = NULL,
       fill = NULL,
       x = "length (mm)",
       y = "frequency (number of lionfish)",
       title = "Fernando de Noronha") +
  theme_classic()+
  facet_wrap(~time, ncol = 1) +
  theme(strip.text = element_blank(),
        aspect.ratio = 1/5)
```

```{r for loop for rj}
lf_sim_rj <- data.frame(start_l_rj = lf_ap13$starting_length,
                     start_a_rj = NaN*length(lf_ap13),
                     a_1_rj = NaN*length(lf_ap13),
                     l_1_rj = NaN*length(lf_ap13),
                     a_2_rj = NaN*length(lf_ap13),
                     l_2_rj = NaN*length(lf_ap13), 
                     a_3_rj = NaN*length(lf_ap13),
                     l_3_rj = NaN*length(lf_ap13),
                     a_4_rj = NaN*length(lf_ap13),
                     l_4_rj = NaN*length(lf_ap13),
                     region = NaN*length(lf_ap13))

for(i in 1:length(lf_sim_rj$start_l_rj)){
    # Starting Age/Length
    a_rj <- lf_nice$tset[lf_nice$length_round == lf_sim_rj$start_l_rj[i]] 
    lf_sim_rj$start_a_rj[i] <- a_rj
    
    # 1-yr Age/Length
    t <- a_rj + 1
    lf_sim_rj$a_1_rj[i] <- t
    lf_sim_rj$l_1_rj[i] <- l_inf *(1-exp(-k_rj*(t-t_0)+(((c*k_rj)/(2*pi))*sinpi(t-t_s))-(((c*k_rj)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim_rj$a_2_rj[i] <- t
    lf_sim_rj$l_2_rj[i] <- l_inf*(1-exp(-k_rj*(t-t_0)+(((c*k_rj)/(2*pi))*sinpi(t-t_s))-(((c*k_rj)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_rj$a_3_rj[i] <- t
    lf_sim_rj$l_3_rj[i] <- l_inf*(1-exp(-k_rj*(t-t_0)+(((c*k_rj)/(2*pi))*sinpi(t-t_s))-(((c*k_rj)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim_rj$a_4_rj[i] <- t
    lf_sim_rj$l_4_rj[i] <- l_inf*(1-exp(-k_rj*(t-t_0)+(((c*k_rj)/(2*pi))*sinpi(t-t_s))-(((c*k_rj)/(2*pi))*sinpi(t_s))))
    
    # include region in the df
    region <- t + 1
    lf_sim_rj$region[i] <- c("Rio de Janeiro")
}

lf_sim_rj_long <- lf_sim_rj %>% 
  select(start_l_rj, l_1_rj, l_2_rj, l_3_rj, l_4_rj, region) %>% 
  pivot_longer(cols = c("start_l_rj", "l_1_rj", "l_2_rj", "l_3_rj", "l_4_rj"),
               names_to = "time",
               values_to = "length") %>% 
  mutate(time = as.factor(case_when(time == "start_l_rj" ~ "Initial Population",
                                    time == "l_1_rj" ~ "After 1 Year",
                                    time == "l_2_rj" ~ "After 2 Years",                            
                                    time == "l_3_rj" ~ "After 3 Years",
                                    time == "l_4_rj" ~ "After 4 Years"))) %>% 
  mutate(time = fct_relevel(time, levels = c("Initial Population", "After 1 Year", 
                                           "After 2 Years",  "After 3 Years", "After 4 Years")))

ggplot(data = lf_sim_rj_long) +
  geom_density_line(aes(x = length, color = time, fill = time), 
                    alpha = 0.5) +
  labs(color = NULL,
       fill = NULL,
       x = "Length (mm)",
       y = "Frequency (number of lionfish)",
       title = "Rio de Janeiro") +
  theme_classic()+
  facet_wrap(~time, ncol = 1) +
  theme(strip.text = element_blank(),
        aspect.ratio = 1/5)
```


```{r}
#lf_all <- plyr::join_all(list(lf_sim_fl_long, lf_sim_m_long, lf_sim_fn_long, lf_sim_rj_long), type = "full")
```

```{r, fig.width=9, fig.height=8}
# ggplot(data = lf_all) +
#   geom_density_line(aes(x = length, color = time, fill = time), 
#                     alpha = 0.5) +
#   labs(color = NULL,
#        fill = NULL,
#        x = "Length (mm)",
#        y = "Frequency (number of lionfish)") +
#   theme_classic()+
#   facet_wrap(region~time) +
#   theme_bw()
```


```{r plot for figure 3 model extension, fig.width=8, fig.height=8}
# (fl_plot + m_plot) /
#   (fn_plot + rj_plot) +
#   plot_annotation(tag_level = c("A"))
```

**Figure 2.** Shifting age and size structure of lionfish population, as sampled in April 2013 in Northeast Florida. A - Northeast Florida, B - Amazon reefs, C - Fernando de Noronha Archipelago, D - Rio de Janeiro. This figure demonstrates growth of a single snapshot of individuals over four years, and does not account for any births, deaths, immigration, or emigration.


```{r}
# Set up loop to iterate model across time/age
tset <- seq(from = 0, to = 4, by = 0.001)
lf <- data.frame(tset, lengths = NaN*tset)
lf_fl <- data.frame(tset, lengths = NaN*tset)
lf_m <- data.frame(tset, lengths = NaN*tset)
lf_fn <- data.frame(tset, lengths = NaN*tset)
lf_rj <- data.frame(tset, lengths = NaN*tset)

for(i in 1:length(tset)){
  t <- tset[i]
  
  # Growth models
  l_t <- l_inf* (1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s)))) # original one
  l_t_fl <- l_inf* (1-exp(-k_fl*(t-t_0)+(((c*k_fl)/(2*pi))*sinpi(t-t_s))-(((c*k_fl)/(2*pi))*sinpi(t_s))))
  l_t_m <- l_inf* (1-exp(-k_m*(t-t_0)+(((c*k_m)/(2*pi))*sinpi(t-t_s))-(((c*k_m)/(2*pi))*sinpi(t_s))))
  l_t_fn <- l_inf* (1-exp(-k_fn*(t-t_0)+(((c*k_fn)/(2*pi))*sinpi(t-t_s))-(((c*k_fn)/(2*pi))*sinpi(t_s))))
  l_t_rj <- l_inf* (1-exp(-k_rj*(t-t_0)+(((c*k_rj)/(2*pi))*sinpi(t-t_s))-(((c*k_rj)/(2*pi))*sinpi(t_s))))
  
  # Storing l_t values per area
  lf$lengths[i] <- l_t
  lf_fl$lengths[i] <- l_t_fl
  lf_m$lengths[i] <- l_t_m
  lf_fn$lengths[i] <- l_t_fn
  lf_rj$lengths[i] <- l_t_rj
}

# Including region for each area's df
lf <- lf %>% 
  mutate(region = "Original model")

lf_rj <- lf_rj %>% 
  mutate(region = "Rio de Janeiro")

lf_fl <- lf_fl %>% 
  mutate(region = "Northeast Florida")

lf_m <- lf_m %>% 
  mutate(region = "Amazon reefs")

lf_fn <- lf_fn %>%
  mutate(region = "Fernando de Noronha")
```

```{r}
# Plot the model output
ggplot() +
  geom_line(data = lf_fl,
            aes(x = tset, y = lengths, color = region)) +
  geom_line(data = lf_m,
            aes(x = tset, y = lengths, color = region)) +
  geom_line(data = lf_fn,
           aes(x = tset, y = lengths, color = region)) +
  geom_line(data = lf_rj,
           aes(x = tset, y = lengths, color = region)) +
  geom_line(data = lf,
            aes(x = tset, y = lengths, color = region),
            alpha = 0.3) +
  labs(x = "Age (Years)",
       y = "Total Length (mm)",
       color = "") +
  theme_classic() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 11),
        legend.position = c(.8, .48),
        legend.text = element_text(size = 12))
```

**Figure 3.** Estimated age-length relationship for lionfish in the modified version of the seasonalized von-Bertalanffy growth equation for each region. 


# Ecological implications of this model extension

As shown in figures 2 and 3, 






