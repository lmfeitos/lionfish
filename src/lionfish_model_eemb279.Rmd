---
title: "lionfish_model_eemb279"
author: "Leonardo Feitosa"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(patchwork)
```

```{r}
# read in the data
lionfish_tl <- read.csv(here("data", "lionfish_length-frequency_data.csv"), sep = ";") %>% 
  clean_names() %>% 
  select(total_length_tl:august_2015)
```

```{r}
lion_ap_2013 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = april_2013)) +
  labs(x = "",
       y = "",
       title = "April 2013") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_aug_2013 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2013)) +
  labs(x = "",
       y = "",
       title = "August 2013") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_ap_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = april_2014)) +
  labs(x = "",
       y = "",
       title = "April 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_jul_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = july_2014)) +
  labs(x = "",
       y = "",
       title = "July 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_aug_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2014)) +
  labs(x = "",
       y = "",
       title = "August 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_oc_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = october_2014)) +
  labs(x = "",
       y = "",
       title = "October 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```


```{r}
lion_nov_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = november_2014)) +
  labs(x = "",
       y = "",
       title = "November 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r}
lion_jan_2015 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = january_2015)) +
  labs(x = "",
       y = "",
       title = "January 2015") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```


```{r}
lion_aug_2015 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2015)) +
  labs(x = "",
       y = "",
       title = "August 2015") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```


```{r, fig.height=10}
(lion_ap_2013 + lion_aug_2013) /
  (lion_ap_2014 + lion_jul_2014) /
  (lion_aug_2014 + lion_oc_2014) /
  (lion_nov_2014 + lion_jan_2015) /
  (lion_aug_2015) +
  plot_annotation(tag_levels = "A")
```

```{r data wrangling}
# create tibble in long format and separate the original year column into month and year
lionfish_long <- lionfish_tl %>% 
  pivot_longer(cols = april_2013:august_2015,
               names_to = "year",
               values_to = "frequency") %>% 
  separate(year, c("month", "year"), "_")

# sum the frequencies per year
lionfish_sum <- lionfish_long %>% 
  group_by(year, total_length_tl) %>% 
  summarise(freq_sum = sum(frequency))
```

## Parameters for the best fit model used in Johnson & Swenarton (2016)

```{r}
l_inf <- 448 #(mm)
t_0 <- 0
k <- 0.47 # Brody growth coefficient
c <- 0.61 # intensity of seasonal growth oscilation. Varies from 0 to 1, with zero being no seasonality and one extreme seasonality
t_s <- 0.71 # can't figure out where this value comes from but it's in the formula
t_b <- 0.42
season <- "yes"
var_size_age <- "variable"
```

```{r}
# create timeseries
tset <- seq(from = 0, to = 100, length.out = 10000)

# placeholder variables
N.simu1 <- NaN*tset
N.simu1[1] <- l_inf # this is probably wrong

# create for loop
for(i in 2:length(tset)) { 
  dt <- tset[i] - tset[i - 1] # change in time
  
  N <- N.simu1[i - 1] # placeholder
  
  # calculate growth from VBGF
  l_t <- l_inf * (1 - exp(- k * (tset - t_0) + (c * k/ 2 * pi) * sin(pi) * (tset - t_s) - (c * k / 2 * pi) * sin(pi) * (t_s))) # formula 8 of the paper
  
  # total growth
  N.simu1[i] <- N + l_t 
}
```


# Begin Cori

## Plot Histograms

```{r}
ggplot(data = lionfish_long) +
  geom_col(aes(x = total_length_tl, y = frequency)) +
  theme_classic() +
  labs(x = "Total Length",
       y = "Frequency") +
  facet_wrap(~year, scales = "free")
```


## Motivation

Invasive species management requires thorough understanding of life history characteristics, which can be used to model population dynamics and analyze effectiveness of various intervention strategies. Lionfish are invasive and have spread rapidly through the western Atlantic, but spatially-explicit estimates for growth rate have not been identified in many regions. This paper uses length-frequency data to estimate lionfish growth rate in one of these areas: northeast Florida. 

## Key Goals & Findings:

1. Develop length-based model to estimate age, growth, and population structure - found rapid growth with seasonal variation

2. Evaluate model performance through validation with otolith analysis and external length-frequency data

3. Estimate vital rates and population structure for the region - distinct cohorts were identifiable, suggesting recruitment occurs during a relatively short summer period; majority of lionfish < 2 years of age, none > 3 years of age

## Methods


### Sampling

Sampling occured from 2013-2015 during "lionfish roundup" tournaments and other opportunistic sampling via spearfishing. In the lab, lionfish were measured for standard and total length, weighed, and sexed. The authors retrieved otoliths from 100 lionfish to determine age directly. 

### Model Creation

- Length-frequency histograms were used for lengths 0-450mm in 10mm increments.
- Only used data from 2014 due to temporal resolution

About the model:

The von Bertalanffy growth function uses length as a proxy for age. For species which experience seasonal temperature variations, such as temperate lionfish, the seasonalized version of this function is often most appropriate:

$$
\begin{align}
Seasonalized:L_t & = L_{inf} [1-e^{-(K(t-t_0))-S(t)+S(t_0)}] \\ 
\newline
S(t)  &= \frac{CK}{2pi}sinpi(t-t_s)
\newline
S(t_0) &= \frac{CK}{2pi}sinpi(t_0-t_s)
\end{align}
$$
$L_t$ = length of fish at age $t$
$L_inf$ = asymptotic maximum length
$K$ = Brody growth coefficient
$t_0$ = theoretical time at which fish was length zero
$t_s$ = seasonal growth oscillations relative to $t_0$
$t_w = t_s + 0.5$ = winter point, time of slowest growth
$C$ = intensity of seasonal growth oscillation, ($0 <= C <=1$ where zero = no seasonality)

Included measure of variance of size-at-age as a parameter, and estimated the proportion of lionfish in each age class during each sampling month and year:
$$
\begin{align}
n_{a, i, t} = N_t  P_{a,t} P(L_{lower} <= L_i <= L_{upper} | N(\bar{L_{a,t}, sigma_a^2}))
\end{align}
$$
$N_t$ = total number of individuals captured in month $t$
$P_{a,t}$ = probability of fish captured in month $t$ being age $a$
$L_{lower}$ and $L_{upper}$ = lower and upper bounds of predcted 10mm size bin
$N(\bar{L_{a,t}}, sigma_a)$ = normal probability density function with mean length $\bar{L_{a,t}}$ of fish of age $a$ in month $t$ as estimated from seasonalized VBGF and model esimated standard deviation at age, $sigma_a$. 

Size distributions overlap across ages, so total expected fish of size $i$ in month $t$ calculated by summing expected contributions to size class $i$ from each age:
$N_{i,t} = \sum_{a=0}^{3}n_{i,a,t}$

Uses maximum likelihood approach to fit a predicted distribution to the length-frequency histogram - length is a proxy for age, so the model estimates the proportion of fish of a given size in each age class. 

Best fit model:
$$
\begin{align}
L_t = 448 [1-e^{-0.47t+[\frac{0.061*0.47}{2pi}]sinpi{t=0.71}]-[\frac{0.61*0.47}{2pi}sinpi{0.71}]}]
\end{align}
$$




 