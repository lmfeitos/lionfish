---
title: "lionfish_model_eemb279"
author: "Leonardo Feitosa"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(tidyverse)
library(here)
library(janitor)
library(patchwork)
```

# Introduction

(Background and context, approximately 200 words, citing at least two additional research papers.)




### Motivation

Invasive species management requires thorough understanding of life history characteristics, which can be used to model population dynamics and analyze effectiveness of various intervention strategies. Lionfish are invasive and have spread rapidly through the western Atlantic, but spatially-explicit estimates for growth rate have not been identified in many regions. This paper uses length-frequency data to estimate lionfish growth rate in one of these areas: northeast Florida. 

### Paper's Key Goals & Findings:

1. Develop length-based model to estimate age, growth, and population structure - found rapid growth with seasonal variation

2. Evaluate model performance through validation with otolith analysis and external length-frequency data

3. Estimate vital rates and population structure for the region - distinct cohorts were identifiable, suggesting recruitment occurs during a relatively short summer period; majority of lionfish < 2 years of age, none > 3 years of age

### Sampling

Sampling occured from 2013-2015 during "lionfish roundup" tournaments and other opportunistic sampling via spearfishing. In the lab, lionfish were measured for standard and total length, weighed, and sexed. The authors retrieved otoliths from 100 lionfish to determine age directly. 

- Length-frequency histograms were used for lengths 0-450mm in 10mm increments.
- Only used data from 2014 due to temporal resolution

## Model Presentation

The von Bertalanffy growth function uses length as a proxy for age. For species which experience seasonal temperature variations, such as temperate lionfish, the seasonalized version of this function is often most appropriate:

$$
\begin{align}
\text{Seasonalized:} 
\newline 
L_t & = L_{inf} [1-e^{-(K(t-t_0))-S(t)+S(t_0)}] \\ 
\newline
S(t)  &= \frac{CK}{2\pi} \cdot sin \pi(t-t_s)
\newline
S(t_0) &= \frac{CK}{2\pi} \cdot sin \pi(t_0-t_s)
\end{align}
$$

$L_t$ = length of fish at age $t$
$L_inf$ = asymptotic maximum length
$K$ = Brody growth coefficient
$t_0$ = theoretical time at which fish was length zero
$t_s$ = seasonal growth oscillations relative to $t_0$
$t_w = t_s + 0.5$ = winter point, time of slowest growth
$C$ = intensity of seasonal growth oscillation, ($0 \leq C \leq 1$ where zero = no seasonality)

Included measure of variance of size-at-age as a parameter, and estimated the proportion of lionfish in each age class during each sampling month and year:

$$
\begin{align}
n_{a,i,t} = N_t \cdot P_{a,t} \cdot P(L_{lower} \leq L_i \leq L_{upper} | N(\bar{L_{a,t}},\sigma_{a}^{2}))
\end{align}
$$
$N_t$ = total number of individuals captured in month $t$
$P_{a,t}$ = probability of fish captured in month $t$ being age $a$
$L_{lower}$ and $L_{upper}$ = lower and upper bounds of predcted 10mm size bin
$N(\bar{L_{a,t}}, sigma_a)$ = normal probability density function with mean length $\bar{L_{a,t}}$ of fish of age $a$ in month $t$ as estimated from seasonalized VBGF and model esimated standard deviation at age, $sigma_a$. 

Size distributions overlap across ages, so total expected fish of size $i$ in month $t$ calculated by summing expected contributions to size class $i$ from each age:
$N_{i,t} = \sum_{a=0}^{3}n_{i,a,t}$

The authors used maximum likelihood approach to fit a predicted distribution to the length-frequency histograms from the samples. Length is a proxy for age, so the model estimates the proportion of fish of a given size in each age class. 

Best fit model:
$$
\begin{align}
L_t = 448 [1-e^{-0.47t+[\frac{0.061*0.47}{2\pi}]sin\pi(t-0.71)]-[\frac{0.61*0.47}{2\pi}sin\pi(0.71)]}]
\end{align}
$$
## Assumptions

For length model:
- Normal distriution of length
- Population consists of four age classes, reach maximum length of 448mm
- The samples collected are reflective of the age-length distribution of the entire population

For distribution:
- Recruitment occurs in single event 

## Replication

### Data Processing

```{r}
# Read length data
lionfish_tl <- read.csv(here("data", "lionfish_length-frequency_data.csv"), sep = ";") %>% 
  clean_names() %>% 
  select(total_length_tl:august_2015) # remove some random extra empty columns

# Create tibble in long format and separate the original year column into month and year
lionfish_long <- lionfish_tl %>% 
  pivot_longer(cols = april_2013:august_2015,
               names_to = "year",
               values_to = "frequency") %>% 
  separate(year, c("month", "year"), "_")

# Sum the frequencies per year
lionfish_sum <- lionfish_long %>% 
  group_by(year, total_length_tl) %>% 
  summarise(freq_sum = sum(frequency))

```

### Length-Frequency Histograms:


```{r, include = FALSE}
lion_ap_2013 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = april_2013)) +
  labs(x = "",
       y = "",
       title = "April 2013") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_aug_2013 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2013)) +
  labs(x = "",
       y = "",
       title = "August 2013") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_ap_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = april_2014)) +
  labs(x = "",
       y = "",
       title = "April 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_jul_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = july_2014)) +
  labs(x = "",
       y = "",
       title = "July 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_aug_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2014)) +
  labs(x = "",
       y = "",
       title = "August 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_oc_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = october_2014)) +
  labs(x = "",
       y = "",
       title = "October 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_nov_2014 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = november_2014)) +
  labs(x = "",
       y = "",
       title = "November 2014") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_jan_2015 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = january_2015)) +
  labs(x = "",
       y = "",
       title = "January 2015") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, include = FALSE}
lion_aug_2015 <- ggplot(data = lionfish_tl) +
  geom_col(aes(x = total_length_tl, y = august_2015)) +
  labs(x = "",
       y = "",
       title = "August 2015") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10))
```

```{r, fig.height=10, include = FALSE}
(lion_ap_2013 + lion_aug_2013) /
  (lion_ap_2014 + lion_jul_2014) /
  (lion_aug_2014 + lion_oc_2014) /
  (lion_nov_2014 + lion_jan_2015) /
  (lion_aug_2015) +
  plot_annotation(tag_levels = "A")
```


```{r}
ggplot(data = lionfish_long) +
  geom_col(aes(x = total_length_tl, y = frequency)) +
  theme_classic() +
  labs(x = "Total Length",
       y = "Frequency") +
  facet_wrap(~year, scales = "free")
```


## Replicating the best fit model used in Johnson & Swenarton (2016)

### Figure 4

```{r}
# Parameters 
l_inf = 448 # asymptotic maximum length
k = 0.47    # Brody growth coefficient
c = 0.61    # intensity of seasonal growth oscillation. 
               # varies from 0 to 1, with zero being no seasonality 
               # and one extreme seasonality
t_0 = 0    # theoretical time when fish was length zero
t_s = 0.71 # timing of seasonal growth oscillation...
              # slowest growth is at winter point, tw = ts + 0.5

# Set up loop to iterate model across time/age
tset <- seq(from = 0, to = 4, by = 0.001)
lf <- data.frame(tset, lengths = NaN*tset)

for(i in 1:length(tset)){
  t <- tset[i]
  l_t <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
  lf$lengths[i] <- l_t
}

# Plot the model output
ggplot() +
  geom_line(data = lf,
            aes(x = tset, y = lengths)) +
  labs(x = "Age (Years)",
       y = "Total Length (mm)") +
  theme_classic()
```

##  Figure 3

Now need to try to use the growth to estmiate the age structure of the population:


```{r}
# Starting age structure,
lf_ap13 <- lionfish_long %>% 
  filter(month == "april" & year == "2013") %>% 
  uncount(frequency) %>% 
  select(total_length_tl) %>% 
  rename(starting_length = total_length_tl) 

# Create table of age-length relationships
# (Nice alternative to solving the model for length)
lf_nice <- lf %>%  
  mutate(length_round = round(lengths, digits = 0))%>% 
  group_by(length_round) %>% 
  slice(1) %>% 
  ungroup()

lf_sim <- data.frame(start_l = lf_ap13$starting_length,
                     start_a    = NaN*length(lf_ap13),
                     a_1 = NaN*length(lf_ap13),
                     l_1 = NaN*length(lf_ap13),
                     a_2 = NaN*length(lf_ap13),
                     l_2 = NaN*length(lf_ap13), 
                     a_3 = NaN*length(lf_ap13),
                     l_3 = NaN*length(lf_ap13),
                     a_4 = NaN*length(lf_ap13),
                     l_4 = NaN*length(lf_ap13))

# Test out first as a loop
for(i in 1:length(lf_sim$start_l)){
    # Starting Age/Length
    a <- lf_nice$tset[lf_nice$length_round == lf_sim$start_l[i]] 
    lf_sim$start_a[i] <- a
    
    # 1-yr Age/Length
    t <- a + 1
    lf_sim$a_1[i] <- t
    lf_sim$l_1[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 2-yr Age/Length
    t <- t + 1
    lf_sim$a_2[i] <- t
    lf_sim$l_2[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
   
    # 3-yr Age/Length
    t <- t + 1
    lf_sim$a_3[i] <- t
    lf_sim$l_3[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
    
    # 3-yr Age/Length
    t <- t + 1
    lf_sim$a_4[i] <- t
    lf_sim$l_4[i] <- l_inf*(1-exp(-k*(t-t_0)+(((c*k)/(2*pi))*sinpi(t-t_s))-(((c*k)/(2*pi))*sinpi(t_s))))
}


  
# Works!
ggplot(data = lf_sim) +
  geom_histogram(aes(x = start_l, fill = "April 2013"), alpha = 0.5)+
  geom_histogram(aes(x = l_1, fill = "April 2013 aged to April 2014"), alpha = 0.5) +
  geom_histogram(aes(x = l_2, fill = "April 2013 aged to April 2015"), alpha = 0.5) +
  geom_histogram(aes(x = l_3, fill = "April 2013 aged to April 2016"), alpha = 0.5) +
  geom_histogram(aes(x = l_4, fill = "April 2013 aged to April 2017"), alpha = 0.5) +
  labs(x = "length", y = "frequency", fill = NULL) +
  theme_classic()



# Next step: write as a function for ease at populating time steps? Or nested time step
```

# Citations

House, C., Redmond, D. & Phillips, M. R. An assessment of the efficiency and ecological representativity of existing marine reserve networks in Wales, UK. Ocean & Coastal Management 149, 217–230 (2017).


